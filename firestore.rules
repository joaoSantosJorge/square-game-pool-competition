service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if request comes from Cloud Functions
    function isCloudFunction() {
      return request.auth.uid != null && 
             request.auth.token.iss == 'https://securetoken.google.com/flappy-bird-leaderboard-463e0';
    }
    
    // Scores collection - anyone can read (except ipAddress), ONLY Cloud Functions can write
    match /scores/{scoreId} {
      // Allow read of all fields except ipAddress
      allow read: if request.query.limit <= 100 && 
                     !("ipAddress" in request.query.select);
      
      // DENY all direct writes from clients - must go through Cloud Function
      allow create, update, delete: if false;
    }
    
    // Cycle state - anyone can read, only Cloud Functions can write
    match /cycleState/{document} {
      allow read: if true;
      allow write: if false; // Only backend/Cloud Functions can modify
    }
    
    // Cycle Metadata - anyone can read, only Cloud Functions can write
    match /cycleMetadata/{document} {
      allow read: if true;
      allow write: if false; // Only backend/Cloud Functions can modify
    }
    
    // User Profiles - anyone can read, only Cloud Functions can write
    match /userProfiles/{userId} {
      allow read: if true;
      allow write: if false; // Only backend/Cloud Functions can modify
    }
    
    // Payments - anyone can read, only Cloud Functions can write
    match /payments/{paymentId} {
      allow read: if true;
      allow write: if false; // Only backend/Cloud Functions can modify
    }
    
    // Archived score collections - anyone can read, only Cloud Functions can write
    match /scores_{date1}_to_{date2}/{scoreId} {
      allow read: if true;
      allow write: if false; // Only backend/Cloud Functions can modify
    }
    
    // Deny everything else by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
